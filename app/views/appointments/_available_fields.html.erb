<%= form_with model: @ctx.appointment,
              url: appointments_path,
              method: :post,
              id: "appointment-create-form",
              local: true,
              data: {
                controller: "recaptcha",
                "recaptcha-site-key-value": ENV.fetch("RECAPTCHA_SITE_KEY", nil),
                action: "submit->recaptcha#onSubmit",
                turbo: false
              },
              class: "mt-6 space-y-6" do |form| %>

  <% if @ctx.appointment.errors.any? %>
    <div class="mb-4 p-4 border border-red-400 rounded-md bg-red-50 text-red-700 shadow-sm">
      <h3 class="font-semibold">
        <%= pluralize(@ctx.appointment.errors.count, "error") %> impidieron guardar la cita:
      </h3>
      <ul class="list-disc pl-6">
        <% @ctx.appointment.errors.full_messages.each do |m| %>
          <li><%= m %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Contexto necesario para crear -->
  <%= form.hidden_field :package_id, value: @ctx.package&.id %>
  <%= form.hidden_field :doctor_id,  value: @ctx.doctor_id %>
  <%= form.hidden_field :duration,   value: @ctx.duration %>
  <%= hidden_field_tag :appointment_date, @ctx.appointment_date %>

  <!-- Selección de hora -->
  <% time_options = Array(@ctx.available_times).map { |t|
       t = t.in_time_zone("America/Mexico_City")
       [t.strftime("%I:%M %p"), t.iso8601]
     } %>
  <div>
    <%= form.label :start_date, "Selecciona una Hora", class: "block text-lg font-medium text-gray-700 mb-2" %>
    <%= form.select :start_date,
          options_for_select(time_options),
          { prompt: "Selecciona una Hora" },
          required: true,
          class: "block w-full p-2 border border-gray-300 rounded-md shadow-sm" %>
  </div>

  <div>
    <%= form.label :name, "Nombre", class: "block text-lg font-medium text-gray-700 mb-2" %>
    <%= form.text_field :name, required: true,
          class: "block w-full p-2 border border-gray-300 rounded-md shadow-sm" %>
  </div>

  <div>
    <%= form.label :age, "Edad", class: "block text-lg font-medium text-gray-700 mb-2" %>
    <%= form.number_field :age, required: true,
          class: "block w-full p-2 border border-gray-300 rounded-md shadow-sm" %>
  </div>

  <div>
    <%= form.label :phone, "Número de Teléfono", class: "block text-lg font-medium text-gray-700 mb-2" %>
    <%= form.telephone_field :phone, required: true,
          class: "block w-full p-2 border border-gray-300 rounded-md shadow-sm" %>
  </div>

  <!-- reCAPTCHA v3 -->
  <input type="hidden" name="recaptcha_token" />

  <%= form.submit "Agendar Cita",
        class: "bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 transition-colors duration-200",
        data: { disable_with: "Agendando…" } %>
<% end %>
