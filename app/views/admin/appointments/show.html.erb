<!-- app/views/admin/appointments/show.html.erb -->
<h1 class="text-3xl font-bold mb-6 text-center">Detalles de la Cita</h1>

<%= render "shared/flash" %>

<div class="bg-white shadow-md rounded-lg p-6 space-y-6" id="appointment-show" data-turbo-cache="false">
  <p class="text-lg">
    <strong class="font-semibold text-gray-700">Nombre:</strong>
    <span class="text-gray-800"><%= @appointment.name.presence || "N/A" %></span>
  </p>

  <p class="text-lg">
    <strong class="font-semibold text-gray-700">Doctor:</strong>
    <span class="text-gray-800"><%= @appointment.doctor&.name || "N/A" %></span>
  </p>

  <p class="text-lg">
    <strong class="font-semibold text-gray-700">Paquete:</strong>
    <span class="text-gray-800"><%= @appointment.package&.name || "N/A" %></span>
  </p>

  <p class="text-lg">
    <strong class="font-semibold text-gray-700">Fecha de la Cita:</strong>
    <span class="text-gray-800">
      <%= I18n.l(@appointment.start_date.in_time_zone("America/Mexico_City"), format: :custom, locale: :es) rescue "N/A" %>
    </span>
  </p>

  <p class="text-lg">
    <strong class="font-semibold text-gray-700">Estado:</strong>
    <span class="text-gray-800"><%= @appointment&.status_label || "N/A" %></span>
  </p>

  <p class="text-lg">
    <strong class="font-semibold text-gray-700">Codigo Unico:</strong>
    <span class="text-gray-800"><%= @appointment.unique_code.presence || "N/A" %></span>
  </p>

  <p class="text-lg">
    <strong class="font-semibold text-gray-700">Teléfono:</strong>
    <span class="text-gray-800"><%= @appointment.phone.presence || "N/A" %></span>
  </p>
</div>

<div class="mt-6 text-center">
  <%= link_to "Regresar a las Citas", admin_appointments_path, class: "text-blue-500 hover:text-blue-700 font-medium" %>
</div>

<%# --- DESCARGA UNA SOLA VEZ Y LIMPIEZA DE URL --- %>
<% if @download_once %>
  <%# Dispara la descarga sin navegar fuera del show %>
  <iframe src="<%= @pdf_url %>" style="display:none;" aria-hidden="true"></iframe>

  <script nonce="<%= content_security_policy_script_nonce if respond_to?(:content_security_policy_script_nonce) %>">
    (function() {
      // Quita ?download=1 para que Turbo no repita la acción al navegar
      try {
        var url = new URL(window.location.href);
        url.searchParams.delete('download');
        window.history.replaceState({}, document.title, url.toString());
      } catch (e) {}
    })();
  </script>
<% end %>
